#!/usr/bin/env python3
from __future__ import annotations

import argparse
import json
import sys
import time
import urllib.error
import urllib.request
from pathlib import Path


def _latest_session_file(session_root: Path) -> Path | None:
    roots = [session_root]
    candidates: list[Path] = []
    for root in roots:
        if not root.exists() or not root.is_dir():
            continue
        for path in root.rglob("*.jsonl"):
            if path.is_file():
                candidates.append(path)
    if not candidates:
        return None
    return max(candidates, key=lambda p: p.stat().st_mtime)


def _parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description="Send one OpenClaw request and persist latest session path.")
    parser.add_argument("--user-input", required=True, help="User input sent to /v1/chat/completions.")
    parser.add_argument(
        "--gateway-url",
        default="http://127.0.0.1:18789/v1/chat/completions",
        help="OpenClaw gateway completions URL.",
    )
    parser.add_argument(
        "--session-root",
        default="/home/node/.openclaw",
        help="Directory root to scan for latest *.jsonl session file.",
    )
    parser.add_argument(
        "--session-path-output",
        default="/tmp/openclaw-last-session-path.txt",
        help="File path used to persist latest session jsonl path.",
    )
    parser.add_argument(
        "--response-output",
        default="/tmp/openclaw-last-response.json",
        help="File path used to persist gateway raw response JSON.",
    )
    return parser.parse_args()


def main() -> int:
    args = _parse_args()
    user_input = str(args.user_input or "").strip()
    payload = {
        "model": "openclaw:main",
        "messages": [
            {
                "role": "user",
                "content": user_input,
            }
        ],
    }

    request_started_at = time.time()
    req = urllib.request.Request(
        url=str(args.gateway_url),
        method="POST",
        headers={
            "Content-Type": "application/json",
            "x-openclaw-agent-id": "main",
        },
        data=json.dumps(payload, ensure_ascii=False).encode("utf-8"),
    )
    response_text: str
    try:
        with urllib.request.urlopen(req, timeout=120) as resp:
            response_text = resp.read().decode("utf-8", errors="replace")
            status = int(resp.status)
    except urllib.error.HTTPError as exc:
        body = exc.read().decode("utf-8", errors="replace")
        print(body, file=sys.stderr)
        return int(exc.code) if exc.code > 0 else 1

    response_output = Path(str(args.response_output))
    response_output.write_text(response_text, encoding="utf-8")
    print(response_text)

    after = _latest_session_file(Path(str(args.session_root)).expanduser())
    if after is None:
        print("no session jsonl generated by openclaw", file=sys.stderr)
        return 2
    after_mtime = after.stat().st_mtime
    if after_mtime + 0.001 < request_started_at:
        print(f"latest session is stale: path={after} mtime={after_mtime} request_start={request_started_at}", file=sys.stderr)
        return 2
    session_path_output = Path(str(args.session_path_output))
    session_path_output.write_text(str(after), encoding="utf-8")

    if status != 200:
        return status
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
