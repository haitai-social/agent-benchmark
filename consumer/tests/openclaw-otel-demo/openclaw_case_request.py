#!/usr/bin/env python3
from __future__ import annotations

import json
import os
import sys
import time
import urllib.error
import urllib.request
from pathlib import Path


def _latest_session_file() -> Path | None:
    home = Path(str(os.getenv("HOME") or "/home/node")).expanduser()
    roots = [home / ".openclaw"]
    candidates: list[Path] = []
    for root in roots:
        if not root.exists() or not root.is_dir():
            continue
        for path in root.rglob("*.jsonl"):
            if path.is_file():
                candidates.append(path)
    if not candidates:
        return None
    return max(candidates, key=lambda p: p.stat().st_mtime)


def main() -> int:
    user_input = str(os.getenv("BENCHMARK_USER_INPUT") or "").strip()
    payload = {
        "model": "openclaw:main",
        "messages": [
            {
                "role": "user",
                "content": user_input,
            }
        ],
    }

    request_started_at = time.time()
    req = urllib.request.Request(
        url="http://127.0.0.1:18789/v1/chat/completions",
        method="POST",
        headers={
            "Content-Type": "application/json",
            "x-openclaw-agent-id": "main",
        },
        data=json.dumps(payload, ensure_ascii=False).encode("utf-8"),
    )
    response_text: str
    try:
        with urllib.request.urlopen(req, timeout=120) as resp:
            response_text = resp.read().decode("utf-8", errors="replace")
            status = int(resp.status)
    except urllib.error.HTTPError as exc:
        body = exc.read().decode("utf-8", errors="replace")
        print(body, file=sys.stderr)
        return int(exc.code) if exc.code > 0 else 1

    Path("/tmp/openclaw-last-response.json").write_text(response_text, encoding="utf-8")
    print(response_text)

    after = _latest_session_file()
    if after is None:
        print("no session jsonl generated by openclaw", file=sys.stderr)
        return 2
    after_mtime = after.stat().st_mtime
    if after_mtime + 0.001 < request_started_at:
        print(f"latest session is stale: path={after} mtime={after_mtime} request_start={request_started_at}", file=sys.stderr)
        return 2
    Path("/tmp/openclaw-last-session-path.txt").write_text(str(after), encoding="utf-8")

    if status != 200:
        return status
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
